<head>
<script src="js/jquery-1.11.0.js"></script>
<script src="js/raphael.js"></script>
<script src="js/clusterfck.js"></script>
<script src="js/lodash.js"></script>
<script src="js/bluebird.js"></script>
<style>
	body {
		display: block;
		margin: 0px;
	}
</style>
</head>

<body>


</body>

<script>
	var data_set;
 	var paper;
	var image;
	var myImg;
	var imgURL;
    var clusters;

    myImg = new Image();

	myImg.onload = function() {
    	paper.image(imgURL, 0,0, myImg.width, myImg.height);
    	paper.setViewBox(0, 0, myImg.width, myImg.height);
	};

	paper = Raphael(0,0, 1000, 800);

	var urlParams;
	(window.onpopstate = function () {
	    var match,
	        pl     = /\+/g,  // Regex for replacing addition symbol with a space
	        search = /([^&=]+)=?([^&]*)/g,
	        decode = function (s) { return decodeURIComponent(s.replace(pl, " ")); },
	        query  = window.location.search.substring(1);

	    urlParams = {};
	    while (match = search.exec(query))
	       urlParams[decode(match[1])] = decode(match[2]);
	})();


	var cluster = function (array_to_cluster, k, callback) {
	    var t_clusters = clusterfck.kmeans(array_to_cluster, k);

	    callback(t_clusters);

	};


	//classify plate!
	$.getJSON("http://localhost:3000/run_open_cfu/" + urlParams['token'], function(data){
		var to_cluster = [];

		data_set = data;
		_.forEach(data, 
			function(val, index, collection) {
				if (val['IsValid'])
				{
					var tmp = [val['Hue'], val['Saturation'], val['Rmean'], val['Gmean'], val['Bmean']]
					tmp.idx = index

					to_cluster.push(tmp);
				}

			});


		cluster(to_cluster, 2, draw_colonies);

				
	});


	var draw_colonies = function(d_clusters) {
		clusters = d_clusters;
		var colors = ["purple", "green", "blue", "yellow", "red"]
		_.forEach(d_clusters, function (cluster_val, cluster_index, cluster_coll) {
			_.forEach(cluster_val, function (colony_val, colony_index, colony_coll) {
				var val = data_set[colony_val.idx]
				paper.circle(val['X'], val['Y']	, val['Radius']*1.2)
					.data("hue", val['Hue'])
					.data("index", cluster_index)
					.attr("stroke-width", 2)
					.attr("fill", colors[cluster_index])
					.attr("opacity", 0.4)
					.click(function() { this.attr("fill", "orange"); this.attr("opacity", "0.8") } );
			});
		});
	};

	//load appropriate image into canvas
	$.getJSON("http://localhost:3000/get_plate/" + urlParams['token'], function(data){
		imgURL = "http://localhost:3000/" + data.filename;
    	myImg.src = imgURL;
	});

</script>


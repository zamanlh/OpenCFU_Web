<head>
<script src="js/jquery-1.11.0.js"></script>
<script src="js/raphael.js"></script>
<script src="js/clusterfck.js"></script>
<script src="js/lodash.js"></script>
<script src="js/bluebird.js"></script>
<script src="js/bootstrap.js"></script>
<script src="js/bootstrap-slider.js"></script>
<script src="js/ocfu_defs.js"></script>


<style>
	body {
		display: block;
		margin: 0px;
	}
	.top-left {
		position: fixed;
		left: 15px;
		top: 15px;
		z-index: 99;
	}
	.ctrl-group {
		height: 280px;
		width: 300px;
		z-index: 100;
		padding: 0 0 0 0;
	}
	.padded{
		padding: 10 10 10 10;
	}
</style>

<link rel="stylesheet" type="text/css" href="css/bootstrap.css">
<link rel="stylesheet" type="text/css" href="css/slider.css">

</head>

<body>

<div class="top-left panel">
	<a href="#" id="show_controlls" class="btn btn-primary" role="button">Show Controlls</a>
</div>

<form id="ocfu_form" role="form" method="POST", action="#">
	<div id="controlls" class="ctrl-group top-left panel">
		<div class="padded">
			<label class="form-group">Cell Radius Filter:</label>

			<div class="input-group">
				<input name="slider_radius" id="slider_radius" type="text" class="span2" value="5,20" data-slider-min="1" data-slider-max="40" data-slider-step="1" data-slider-value="[5, 20]" data-slider-orientation="horizontal" data-slider-selection="after" data-slider-tooltip="show">
			</div>

		</div>

		<div class="padded">
			<select class="form-control" name="threshold">
				<option value="reg">Regular</option>
				<option value="inv">Inverted</option>
				<option value="bil">Bilateral</option>
			</select>

			<div class="padded">
				<label class="form-group">Filter Threshold:</label>

				<div class="input-group">
					<input type="text" name="slider_threshold" id="slider_threshold" class="span2" value="5" data-slider-min="0" data-slider-max="20" data-slider-step="1" data-slider-value="3" data-slider-orientation="horizontal" data-slider-selection="after" data-slider-tooltip="show">
					<span class="l">
						<label><input type="checkbox" name="auto_threshold" value="1">Auto</label>
					</span>
				</div>
			</div>
		</div>

		<div class="btn-group container padded">
			<button href="#" id="run_ocfu" class="btn btn-lrg btn-danger" role="button" type="submit">Run OpenCFU!</a>
			<button href="#" id="hide_controlls" class="btn btn-sml btn-default" role="button">Hide Controlls</a>
		</div>
	</div>
</form>

</body>

<script>
	$('#slider_radius').slider()
	$('#slider_threshold').slider()

	$('#hide_controlls').click(function(d) {
		console.log(d);
		$('#controlls')[0].style.zIndex = 0;
	})

	$('#show_controlls').click(function(d) {
		console.log(d);
		$('#controlls')[0].style.zIndex = 100;
	})

	$('#ocfu_form').submit(function() {
		//remove old circles
		$('circle').remove();

		//classify plate!
		$.getJSON(api_server + "/run_open_cfu/" + urlParams['token']+ "?" + $("#ocfu_form").serialize(), function(data){
			var to_cluster = [];

			data_set = data;
			_.forEach(data, 
				function(val, index, collection) {
					if (val['IsValid'])
					{
						var tmp = [val['Hue'], val['Saturation'], val['Rmean'], val['Gmean'], val['Bmean']]
						tmp.idx = index

						to_cluster.push(tmp);
					}
				});
			cluster(to_cluster, 2, draw_colonies);
		});

		return false;
	});


	// First, checks if it isn't implemented yet.
	if (!String.prototype.format) {
		String.prototype.format = function() {
	 		var args = arguments;
			return this.replace(/{(\d+)}/g, function(match, number) { 
				return typeof args[number] != 'undefined'
				? args[number]
				: match
				;
			});
		};
	}

	var data_set;
 	var paper;
	var image;
	var myImg;
	var imgURL;
	var clusters;

	myImg = new Image();

	myImg.onload = function() {
		paper.image(imgURL, 0,0, myImg.width, myImg.height);
		paper.setViewBox(0, 0, myImg.width, myImg.height);
	};

	paper = Raphael(0,0, 1000, 800);

	var urlParams;

	(window.onpopstate = function () {
		var match,
		pl = /\+/g,  // Regex for replacing addition symbol with a space
		search = /([^&=]+)=?([^&]*)/g,
			decode = function (s) { return decodeURIComponent(s.replace(pl, " ")); },
			query  = window.location.search.substring(1);

		urlParams = {};
		while (match = search.exec(query))
			urlParams[decode(match[1])] = decode(match[2]);
	})();


	var cluster = function (array_to_cluster, k, callback) {
		var t_clusters = clusterfck.kmeans(array_to_cluster, k);

		callback(t_clusters);

	};


	//classify plate!
	$.getJSON( api_server + "/run_open_cfu/" + urlParams['token'], function(data){
		var to_cluster = [];

		data_set = data;
		_.forEach(data, 
			function(val, index, collection) {
				if (val['IsValid'])
				{
					var tmp = [val['Hue'], val['Saturation'], val['Rmean'], val['Gmean'], val['Bmean']]
					tmp.idx = index

					to_cluster.push(tmp);
				}
			});
		cluster(to_cluster, 2, draw_colonies);
	});


	var draw_colonies = function(d_clusters) {
		clusters = d_clusters;
		var colors = ["purple", "green", "blue", "yellow", "red"]
		_.forEach(d_clusters, function (cluster_val, cluster_index, cluster_coll) {
			_.forEach(cluster_val, function (colony_val, colony_index, colony_coll) {
				var val = data_set[colony_val.idx]
				paper.circle(val['X'], val['Y']	, val['Radius']*1.2)
					.data("hue", val['Hue'])
					.data("index", cluster_index)
					.attr("stroke-width", 2)
					.attr("fill", colors[cluster_index])
					.attr("opacity", 0.4)
					.click(function() { this.attr("fill", "orange"); this.attr("opacity", "0.8") } );
			});
		});
	};

	//load appropriate image into canvas
	$.getJSON(api_server + "/get_plate/" + urlParams['token'], function(data){
		imgURL = api_server + '/' +  data.filename;
		myImg.src = imgURL;
	});

</script>

